<div class="chat-container">
  <div class="chat-header">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
      <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <h4>Mensagens</h4>
    @if (readOnly()) {
      <span class="readonly-badge">Somente leitura</span>
    }
    @if (!readOnly() && unreadCount() > 0) {
      <button
        class="mark-read-btn"
        (click)="markAllAsRead()"
        [disabled]="isMarkingAsRead()"
      >
        @if (isMarkingAsRead()) {
          <div class="loading-spinner-xs"></div>
        } @else {
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
            <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M1 12l5 5L17 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        }
        Marcar como lidas
        <span class="unread-badge">{{ unreadCount() }}</span>
      </button>
    }
  </div>

  <div class="messages-area" #messagesContainer>
    @if (isLoadingMessages() && messages().length === 0) {
      <div class="loading-state">
        <div class="loading-spinner-sm"></div>
        <span>Carregando mensagens...</span>
      </div>
    } @else if (messages().length === 0) {
      <div class="empty-state">
        <span>Nenhuma mensagem ainda. Descreva o problema para o moderador.</span>
      </div>
    } @else {
      @if (hasMore()) {
        <button class="load-more-btn" (click)="loadMoreMessages()">
          Carregar anteriores
        </button>
      }
      @for (msg of messages(); track msg.id) {
        <div class="message" [class.own]="isOwnMessage(msg)" [class.moderator]="msg.sender_role === 'moderator'" [class.unread]="isMessageUnread(msg)">
          <div class="message-header">
            @if (isMessageUnread(msg)) {
              <span class="unread-dot"></span>
            }
            <span class="role-badge" [class]="'role-' + msg.sender_role">
              {{ getRoleLabel(msg.sender_role) }}
            </span>
            <span class="timestamp">{{ formatTime(msg.created_at) }}</span>
          </div>
          <div class="message-bubble">
            {{ msg.content }}
          </div>
        </div>
      }
    }
  </div>

  @if (!readOnly() && currentUserRole()) {
    <div class="input-area">
      @if (messageError()) {
        <div class="error-msg">{{ messageError() }}</div>
      }
      <div class="input-row">
        <textarea
          class="message-input"
          placeholder="Digite sua mensagem..."
          [ngModel]="messageText()"
          (ngModelChange)="messageText.set($event)"
          (keydown)="onKeyDown($event)"
          [disabled]="isSendingMessage()"
          rows="2"
          maxlength="1000"
        ></textarea>
        <button
          class="send-btn"
          (click)="sendMessage()"
          [disabled]="!canSend()"
        >
          @if (isSendingMessage()) {
            <div class="loading-spinner-sm"></div>
          } @else {
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <line x1="22" y1="2" x2="11" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <polygon points="22 2 15 22 11 13 2 9 22 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          }
        </button>
      </div>
      @if (charCount() > 900) {
        <div class="char-counter">{{ charCount() }} / 1000</div>
      }
    </div>
  }
</div>
