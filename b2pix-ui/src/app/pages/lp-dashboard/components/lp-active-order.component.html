<div class="active-order">
  <!-- Timer -->
  <div class="timer-bar" [class.warning]="remainingMinutes() < 5" [class.critical]="remainingMinutes() < 2">
    <div class="timer-icon">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
        <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <div class="timer-text">
      <span class="timer-label">Tempo restante</span>
      <span class="timer-value">{{ formatCountdown() }}</span>
    </div>
    <div class="timer-progress">
      <div class="timer-progress-bar" [style.width.%]="progressPercent()"></div>
    </div>
  </div>

  <!-- Values -->
  <div class="values-section">
    <div class="value-card highlight">
      <span class="label">Valor PIX</span>
      <span class="value brl">R$ {{ formatBrlCents(order().pix_value) }}</span>
    </div>
    <div class="value-card">
      <span class="label">Tipo</span>
      <span class="value">{{ getSourceLabel(order().source_type) }}</span>
    </div>
  </div>

  <!-- PIX Payment Info (conditional on source_type) -->
  @if (order().qr_code_payload) {
    <!-- PIX Copia e Cola (for pix_order) -->
    <div class="pix-payload-section">
      <h3>PIX Copia e Cola</h3>
      <p class="instruction">Copie o codigo abaixo e cole no aplicativo do seu banco para pagar o PIX.</p>
      <div class="payload-display">
        <code>{{ order().qr_code_payload }}</code>
        <button class="btn-copy" (click)="copyPayload()" [disabled]="payloadCopied()">
          @if (payloadCopied()) {
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Copiado!
          } @else {
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
              <path d="M5 15H4C3.46957 15 2.96086 14.7893 2.58579 14.4142C2.21071 14.0391 2 13.5304 2 13V4C2 3.46957 2.21071 2.96086 2.58579 2.58579C2.96086 2.21071 3.46957 2 4 2H13C13.5304 2 14.0391 2.21071 14.4142 2.58579C14.7893 2.96086 15 3.46957 15 4V5" stroke="currentColor" stroke-width="2"/>
            </svg>
            Copiar
          }
        </button>
      </div>
    </div>
  } @else if (order().pix_key) {
    <!-- PIX Key (for sell_order) -->
    <div class="pix-payload-section">
      <h3>Chave PIX do Vendedor</h3>
      <p class="instruction">Realize o pagamento PIX para a chave abaixo.</p>
      <div class="payload-display">
        <code>{{ order().pix_key }}</code>
        <button class="btn-copy" (click)="copyPixKey()" [disabled]="payloadCopied()">
          @if (payloadCopied()) {
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Copiado!
          } @else {
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
              <path d="M5 15H4C3.46957 15 2.96086 14.7893 2.58579 14.4142C2.21071 14.0391 2 13.5304 2 13V4C2 3.46957 2.21071 2.96086 2.58579 2.58579C2.96086 2.21071 3.46957 2 4 2H13C13.5304 2 14.0391 2.21071 14.4142 2.58579C14.7893 2.96086 15 3.46957 15 4V5" stroke="currentColor" stroke-width="2"/>
            </svg>
            Copiar
          }
        </button>
      </div>
    </div>
  }

  <!-- PIX ID Input -->
  <div class="pix-id-section">
    <h3>Confirmar Pagamento</h3>
    <p class="instruction">Apos pagar o PIX, informe o ID da transacao (End-to-End ID) para confirmar.</p>
    <div class="form-group">
      <label class="form-label">ID da Transacao PIX (E2E)</label>
      <input
        type="text"
        class="form-input"
        placeholder="E12345678202506151230abcdef123456"
        [(ngModel)]="pixIdValue"
        [disabled]="isProcessing()"
      />
    </div>
  </div>

  <!-- Actions -->
  <div class="actions">
    <button
      class="btn btn-success btn-lg"
      (click)="onConfirmPayment()"
      [disabled]="!pixIdValue.trim() || isProcessing()">
      @if (isProcessing() && processingAction() === 'pay') {
        <div class="loading-spinner-sm"></div>
        Confirmando...
      } @else {
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
        </svg>
        Confirmar Pagamento
      }
    </button>

    <div class="secondary-actions">
      <button
        class="btn btn-outline"
        (click)="onCancel()"
        [disabled]="isProcessing()">
        @if (isProcessing() && processingAction() === 'cancel') {
          <div class="loading-spinner-sm"></div>
          Cancelando...
        } @else {
          Cancelar
        }
      </button>

      <button
        class="btn btn-ghost"
        (click)="showReportModal.set(true)"
        [disabled]="isProcessing()">
        Reportar Problema
      </button>
    </div>
  </div>

  <!-- Report Modal -->
  @if (showReportModal()) {
    <div class="modal-overlay" (click)="showReportModal.set(false)">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Reportar Problema</h3>
          <button class="modal-close" (click)="showReportModal.set(false)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <p>Descreva o problema encontrado ao tentar pagar este PIX.</p>
          <textarea
            class="form-input"
            rows="4"
            placeholder="Ex: PIX rejeitado pelo banco, dados invalidos..."
            [(ngModel)]="reportReason"
          ></textarea>
        </div>
        <div class="modal-actions">
          <button class="btn btn-outline" (click)="showReportModal.set(false)">Cancelar</button>
          <button
            class="btn btn-primary"
            [disabled]="!reportReason.trim() || isProcessing()"
            (click)="onReport()">
            @if (isProcessing() && processingAction() === 'report') {
              <div class="loading-spinner-sm"></div>
              Enviando...
            } @else {
              Enviar Report
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>
