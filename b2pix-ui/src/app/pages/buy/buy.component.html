<div class="buy-page">
  <!-- Main Content -->
  <div class="container">
    <!-- Simple Header -->
    <div class="page-header">
      <button class="btn btn-ghost" (click)="goBack()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M19 12H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Voltar
      </button>
      <div class="header-content">
        <h1 class="page-title">Comprar Bitcoin</h1>
        <p class="page-subtitle">Escolha quanto você quer comprar e pague com PIX instantâneo</p>
      </div>
    </div>

    <!-- Quick Buy Amount Selector -->
    <div class="quick-buy-section">
      <h2 class="section-title">Quanto você quer comprar?</h2>
      <div class="amount-selector">
        <div class="quick-amounts">
          <button
            class="quick-amount-btn"
            [class.active]="selectedQuickAmount() === 50"
            (click)="selectQuickAmount(50)"
          >
            R$ 50
          </button>
          <button
            class="quick-amount-btn"
            [class.active]="selectedQuickAmount() === 250"
            (click)="selectQuickAmount(250)"
          >
            R$ 250
          </button>
          <button
            class="quick-amount-btn"
            [class.active]="selectedQuickAmount() === 500"
            (click)="selectQuickAmount(500)"
          >
            R$ 500
          </button>
          <button
            class="quick-amount-btn"
            [class.active]="selectedQuickAmount() === 1000"
            (click)="selectQuickAmount(1000)"
          >
            R$ 1.000
          </button>
        </div>
        <div class="custom-amount">
          <label for="customAmount">Ou digite o valor:</label>
          <div class="amount-input-group">
            <span class="currency-symbol">R$</span>
            <input
              type="number"
              id="customAmount"
              [value]="customAmount()"
              (input)="onCustomAmountChange(+$any($event.target).value)"
              placeholder="0,00"
              class="amount-input"
              min="50"
              max="10000"
              step="0.01"
            >
          </div>
        </div>
      </div>
    </div>

    <!-- Bitcoin Estimate Display -->
    <div class="estimate-section">
      <div class="section-header">
        <h2 class="section-title">Valor estimado para Compra</h2>
        @if (currentQuotePrice()) {
          <div class="btc-price-display">
            <span class="price-label">Preço BTC:</span>
            <span class="price-value">R$ {{ formatCurrency(currentQuotePrice()! / 100) }}</span>
          </div>
        }
      </div>

      @if (isLoadingQuote()) {
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <p>Buscando cotação...</p>
        </div>
      } @else if (getCurrentAmount() > 0 && currentQuotePrice()) {
        <div class="estimate-card">
          <div class="estimate-row">
            <span class="estimate-label">Você está comprando:</span>
            <span class="estimate-value">R$ {{ formatCurrency(getCurrentAmount()) }}</span>
          </div>
          <div class="estimate-row highlight">
            <span class="estimate-label">Você receberá (estimativa):</span>
            <span class="estimate-value btc">{{ formatBitcoinAmount(getEstimatedBitcoinAmount()) }} BTC</span>
          </div>
          <div class="estimate-row">
            <span class="estimate-label">Em satoshis:</span>
            <span class="estimate-value sats">{{ formatSats(getEstimatedBitcoinAmountInSats()) }} sats</span>
          </div>
          <div class="estimate-note">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
              <path d="M12 16V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M12 8H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>O valor final em BTC será calculado no momento da confirmação do pagamento</span>
          </div>
        </div>

        <div class="buy-action-container">
          @if (!isAccountValidated()) {
            <div class="validation-required-card">
              <div class="validation-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                  <path d="M12 9V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <circle cx="12" cy="17" r="1" fill="currentColor"/>
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                </svg>
              </div>
              <h3>Validação de Conta Necessária</h3>
              <p>{{ getValidationRequiredMessage() }}</p>
              <button class="btn btn-primary btn-lg" (click)="goToValidation()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                  <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                </svg>
                Iniciar Validação
              </button>
            </div>
          } @else {
            <button
              class="btn btn-success btn-lg buy-btn"
              (click)="startBuyProcess()"
              [disabled]="isProcessingPurchase()"
            >
              @if (isProcessingPurchase()) {
                <div class="loading-spinner-sm"></div>
                Processando...
              } @else {
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                  <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                </svg>
                Comprar Bitcoin com PIX
              }
            </button>
          }
        </div>
      } @else if (getCurrentAmount() > 0) {
        <div class="info-message">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
            <path d="M12 16V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 8H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Digite um valor para ver a estimativa</span>
        </div>
      } @else {
        <div class="info-message">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
            <path d="M12 16V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 8H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Selecione um valor para começar</span>
        </div>
      }
    </div>

    <!-- Buy Order History -->
    <app-buy-history />

    <!-- Purchase Confirmation Modal - Step by Step (keeping same 4-step flow) -->
    @if (showConfirmationModal()) {
      <div class="modal-overlay">
        <div class="confirmation-modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <div class="header-content">
              <h3>Preparação para Compra</h3>
              <div class="step-indicator">Passo {{ currentModalStep() }}/4</div>
            </div>
            <button class="close-btn" (click)="closeConfirmationModal()">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>

          <div class="modal-content">
            <!-- Step 1: Open Banking App -->
            @if (currentModalStep() === 1) {
              <div class="step-content">
                <div class="step-icon">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <h4 class="step-title">Abra seu aplicativo do banco</h4>
                <p class="step-description">Para agilizar o processo, abra agora seu aplicativo bancário</p>

                <div class="step-checkbox">
                  <label class="checkbox-label">
                    <input
                      type="checkbox"
                      [checked]="step1Confirmed()"
                      (change)="toggleStep1($any($event.target).checked)"
                    >
                    <span class="checkbox-custom"></span>
                    <span class="checkbox-text">Abri meu aplicativo bancário e estou pronto para fazer o PIX</span>
                  </label>
                </div>
              </div>
            }

            <!-- Step 2: Confirm Balance -->
            @if (currentModalStep() === 2) {
              <div class="step-content">
                <div class="step-icon">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2V22M17 5H9.5C8.57174 5 7.6815 5.36875 7.02513 6.02513C6.36875 6.6815 6 7.57174 6 8.5C6 9.42826 6.36875 10.3185 7.02513 10.9749C7.6815 11.6313 8.57174 12 9.5 12H14.5C15.4283 12 16.3185 12.3687 16.9749 13.0251C17.6313 13.6815 18 14.5717 18 15.5C18 16.4283 17.6313 17.3185 16.9749 17.9749C16.3185 18.6313 15.4283 19 14.5 19H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <h4 class="step-title">Confirme seu saldo</h4>
                <div class="amount-highlight">
                  <span class="amount-label">Você precisa ter disponível:</span>
                  <span class="amount-value">R$ {{ formatCurrency(getCurrentAmount()) }}</span>
                </div>

                <div class="step-checkbox">
                  <label class="checkbox-label">
                    <input
                      type="checkbox"
                      [checked]="step2Confirmed()"
                      (change)="toggleStep2($any($event.target).checked)"
                    >
                    <span class="checkbox-custom"></span>
                    <span class="checkbox-text">Confirmei que tenho saldo disponível de R$ {{ formatCurrency(getCurrentAmount()) }}</span>
                  </label>
                </div>
              </div>
            }

            <!-- Step 3: PIX Instructions -->
            @if (currentModalStep() === 3) {
              <div class="step-content">
                <div class="step-icon">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                    <path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <h4 class="step-title">Como funciona o pagamento</h4>
                <ul class="instruction-list">
                  <li>Você receberá uma <strong>chave PIX</strong> para pagar</li>
                  <li>Após fazer o PIX, precisará informar os <strong>3 últimos caracteres</strong> do ID da transação</li>
                  <li>Exemplo: ID da transação <span class="id-example">E000-12A<span class="highlight-chars">9Z7</span></span></li>
                </ul>

                <div class="step-checkbox">
                  <label class="checkbox-label">
                    <input
                      type="checkbox"
                      [checked]="step3Confirmed()"
                      (change)="toggleStep3($any($event.target).checked)"
                    >
                    <span class="checkbox-custom"></span>
                    <span class="checkbox-text">Entendi como fazer o PIX e informar os 3 últimos caracteres</span>
                  </label>
                </div>
              </div>
            }

            <!-- Step 4: Final Confirmation -->
            @if (currentModalStep() === 4) {
              <div class="step-content">
                <div class="final-amount">
                  <span class="final-label">Valor a pagar:</span>
                  <span class="final-value">R$ {{ formatCurrency(getCurrentAmount()) }}</span>
                </div>

                <div class="final-estimate">
                  <span class="estimate-label">Estimativa de Bitcoin:</span>
                  <span class="estimate-value">{{ formatBitcoinAmount(getEstimatedBitcoinAmount()) }} BTC</span>
                  <span class="estimate-sats">({{ formatSats(getEstimatedBitcoinAmountInSats()) }} sats)</span>
                </div>

                <div class="final-warning">
                  <div class="warning-header">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                      <path d="M12 9v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <strong>ATENÇÃO - Informações importantes:</strong>
                  </div>
                  <ul class="warning-list">
                    <li>Você terá <strong>5 minutos</strong> após confirmar para fazer o PIX e informar os 3 últimos caracteres</li>
                    <li>O valor final em BTC será calculado no momento da <strong>confirmação do pagamento</strong></li>
                    <li>Se tiver algum problema, <strong>CANCELE</strong> esta compra e comece uma nova</li>
                  </ul>
                </div>
              </div>
            }

            <!-- Navigation Buttons -->
            <div class="modal-actions">
              @if (currentModalStep() === 1) {
                <button class="btn btn-outline" (click)="closeConfirmationModal()">
                  Cancelar
                </button>
                <button
                  class="btn btn-primary"
                  (click)="nextStep()"
                  [disabled]="!canProceedToNextStep()"
                >
                  Próximo
                </button>
              } @else if (currentModalStep() === 4) {
                <button class="btn btn-outline" (click)="previousStep()">
                  Voltar
                </button>
                <button
                  class="btn btn-success btn-lg confirm-purchase-btn"
                  (click)="confirmPurchase()"
                  [disabled]="isProcessingPurchase() || !allStepsCompleted()"
                >
                  @if (isProcessingPurchase()) {
                    <div class="loading-spinner-sm"></div>
                    Processando...
                  } @else {
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                      <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Confirmar Compra
                  }
                </button>
              } @else {
                <button class="btn btn-outline" (click)="previousStep()">
                  Voltar
                </button>
                <button
                  class="btn btn-primary"
                  (click)="nextStep()"
                  [disabled]="!canProceedToNextStep()"
                >
                  Próximo
                </button>
              }
            </div>
          </div>
        </div>
      </div>
    }
  </div>
</div>
